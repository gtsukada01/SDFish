<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SD Fishing - Premium Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: hsl(0 0% 100%);
            min-height: 100vh;
            color: hsl(222.2 84% 4.9%);
            line-height: 1.5;
        }
        
        .app-container {
            min-height: 100vh;
            background: hsl(0 0% 100%);
        }
        /* Shadcn Navigation */
        .navbar {
            background: hsl(0 0% 100%);
            border-bottom: 1px solid hsl(214.3 31.8% 91.4%);
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            height: 60px;
        }
        
        .logo {
            font-weight: 600;
            font-size: 16px;
            color: hsl(222.2 84% 4.9%);
            text-decoration: none;
        }
        .nav-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 8px;
            color: hsl(215.4 16.3% 46.9%);
            font-size: 14px;
            white-space: nowrap;
        }
        
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 8px 16px 16px 16px;
        }
        
        /* Compact Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: hsl(0 0% 100%);
            border: 1px solid hsl(214.3 31.8% 91.4%);
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            display: flex;                 /* center content */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 120px;             /* balanced tile height */
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: hsl(222.2 84% 4.9%);
            line-height: 1;
        }
        
        .stat-label {
            font-size: 14px;
            color: hsl(215.4 16.3% 46.9%);
            font-weight: 500;
            margin-top: 8px;
        }
        /* Shadcn Chart Containers */
        .chart-container {
            background: hsl(0 0% 100%);
            border: 1px solid hsl(214.3 31.8% 91.4%);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
        
        .chart-header {
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: hsl(222.2 84% 4.9%);
        }
        
        .chart-canvas {
            max-height: 400px;
            width: 100% !important; /* ensure full width on mobile */
        }
        /* Scrollable wrapper for charts with many categories (mobile-friendly) */
        .chart-scroll {
            max-height: 380px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        /* Shadcn Filter Bar - No Box (Integrated as Content) */
        .top-filter-bar {
            background: transparent;
            padding: 20px 0 16px 0;
        }
        
        .filter-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .filter-left {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 0 1 auto;
            min-width: 0; /* allow flex children to shrink */
        }
        .filter-right {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1 1 0;
            min-width: 0; /* allow flex children to shrink */
        }
        .filter-right .filter-select {
            width: 100%;
        }
        
        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }
        
        .date-range-display {
            background: hsl(0 0% 100%);
            border: 1px solid hsl(214.3 31.8% 91.4%);
            border-radius: 6px;
            padding: 8px 32px 8px 12px;
            font-size: 14px;
            font-weight: 500;
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            color: hsl(222.2 84% 4.9%);
            cursor: pointer;
            min-width: 240px;
            transition: border-color 0.2s, background-image 0.2s;
            background-image: url("data:image/svg+xml,%3csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M1 1L5 5L9 1' stroke='%236b7280' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 12px;
            position: relative;
        }
        
        .date-range-display.expanded {
            background-image: url("data:image/svg+xml,%3csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M9 5L5 1L1 5' stroke='%236b7280' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
        }
        
        .date-range-display:hover {
            border-color: hsl(214.3 31.8% 81.4%);
        }
        
        .filter-select {
            background: hsl(0 0% 100%);
            border: 1px solid hsl(214.3 31.8% 91.4%);
            border-radius: 6px;
            padding: 8px 32px 8px 12px;
            font-size: 14px;
            color: hsl(222.2 84% 4.9%);
            cursor: pointer;
            min-width: 120px;
            transition: border-color 0.2s;
            background-image: url("data:image/svg+xml,%3csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M1 1L5 5L9 1' stroke='%236b7280' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 12px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: hsl(221.2 83.2% 53.3%);
            box-shadow: 0 0 0 2px hsl(221.2 83.2% 53.3% / 0.2);
        }
        
        .reset-filters {
            background: hsl(0 0% 100%);
            border: 1px solid hsl(214.3 31.8% 91.4%);
            color: hsl(215.4 16.3% 46.9%);
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .reset-filters:hover {
            background: hsl(210 40% 98%);
            color: hsl(222.2 84% 4.9%);
        }
        
        /* Shadcn-style Date Picker Popover */
        .date-picker-popover {
            position: absolute;
            z-index: 50;
            min-width: 320px;
            border-radius: 6px;
            border: 1px solid hsl(214.3 31.8% 91.4%);
            background: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.2s ease;
            top: 100%;
            left: 0;
            margin-top: 4px;
        }
        
        .date-picker-popover.expanded {
            max-height: 200px;
            opacity: 1;
        }
        
        .date-picker-content {
            padding: 12px;
        }
        
        .date-picker-inputs {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .input-group {
            flex: 1;
        }
        
        .date-input {
            width: 100%;
            height: 36px;
            padding: 8px 12px;
            border: 1px solid hsl(214.3 31.8% 91.4%);
            border-radius: 4px;
            font-size: 14px;
            background: white;
            transition: border-color 0.2s;
        }
        
        .date-input:focus {
            outline: none;
            border-color: hsl(221.2 83.2% 53.3%);
            box-shadow: 0 0 0 2px hsl(221.2 83.2% 53.3% / 0.2);
        }
        
        .date-separator {
            font-size: 14px;
            color: hsl(215.4 16.3% 46.9%);
            padding: 0 4px;
        }
        
        .date-presets {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
        }
        
        .preset-btn {
            padding: 8px 12px;
            font-size: 13px;
            border: none;
            background: transparent;
            color: hsl(222.2 84% 4.9%);
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: left;
        }
        
        .preset-btn:hover {
            background: hsl(210 40% 98%);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            /* Consistent mobile gutter to avoid shifting */
            .nav-container {
                padding: 12px 16px;
            }

            .nav-links {
                display: none;
            }

            .container {
                padding: 16px;
            }

            /* Three-row mobile layout: Calendar, Species+Duration, All Boats */
            .top-filter-bar { padding: 16px 0; }
            .filter-container {
                display: grid;                 /* override flex on mobile */
                grid-template-columns: 1fr;    /* single column stack */
                align-items: stretch;
                gap: 12px;
                padding: 0 16px;
            }
            .filter-left {
                display: flex;                 /* Use flexbox for better control */
                flex-wrap: wrap;              /* Allow wrapping */
                gap: 12px;
                min-width: 0;                  /* allow shrinking without overflow */
            }

            /* Calendar takes full width */
            .filter-left .filter-item:first-child {
                width: 100%;
            }

            /* Make species and duration sit side by side on mobile */
            .filter-left .filter-item:nth-child(2),
            .filter-left .filter-item:nth-child(3) {
                flex: 1 1 calc(50% - 6px);    /* Each takes half width minus gap */
                min-width: 0;
            }

            /* Ensure select elements take full width of their containers */
            .filter-left .filter-item .filter-select {
                width: 100%;
                min-width: 0;
            }

            .filter-right { min-width: 0; }

            /* Only date and boat get full width */
            .filter-right .filter-item,
            .filter-right .filter-select,
            .date-range-display,
            #boatSelect {
                width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .date-range-display {
                min-width: 0;   /* fit in half width */
                font-size: 13px;
                white-space: nowrap;       /* prevent wrapping to 2 rows */
                overflow: hidden;          /* clip overflow */
                text-overflow: ellipsis;   /* show … when too long */
                height: 36px;              /* consistent control height */
                display: inline-flex;      /* center text vertically */
                align-items: center;
            }
            
            .filter-select {
                min-width: 0;   /* prevent forcing overflow */
                font-size: 13px;
                height: 36px;   /* match date control height */
            }
            
            /* Place Reset below and align right across both columns */
            .reset-filters { grid-column: 1 / -1; justify-self: end; }
            /* Chart tiles align to container gutter */
            .chart-container {
                margin-left: 0;
                margin-right: 0;
                width: 100%;
            }
        }
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .reset-btn:hover {
            background: #e5e7eb;
        }
        
        @media (max-width: 768px) {
            .filters-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
        .loading {
            text-align: center;
            font-size: 18px;
            color: #666;
        }
        .moon-phase-icon {
            font-size: 1.5em;
            margin-right: 5px;
        }
        .error {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .boat-detail {
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .boat-detail .boat-arrow {
            margin-left: auto;
            color: #666;
            display: flex;
            align-items: center;
            line-height: 1;
        }
        .boat-detail:hover {
            background-color: #e3f2fd !important;
            transform: translateX(5px);
        }
        .boat-expanded {
            background-color: #f0f8ff !important;
            border-left: 3px solid #1976d2 !important;
        }
        .species-breakdown {
            margin: 8px 0 8px 20px;
            padding: 8px;
            background: #fafafa;
            border-radius: 4px;
            font-size: 0.9em;
            border-left: 2px solid #4caf50;
        }
        .clickable-hint {
            color: #666;
            font-size: 0.8em;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Premium Navigation -->
        <nav class="navbar">
            <div class="nav-container">
                <a href="#" class="logo">
                    SD Fishing
                </a>
                <div class="nav-right">
                    <span id="nextMoonPhaseBanner" title="Days until next lunar phase">--</span>
                </div>
            </div>
        </nav>
        
        <!-- Compact Top Filter Bar -->
        <div class="top-filter-bar">
            <div class="filter-container">
                <div class="filter-left">
                    <div class="filter-item">
                        <div class="date-range-display" id="dateRangeDisplay" onclick="toggleCalendarExpansion()">
                            Loading...
                        </div>
                        
                        <!-- Shadcn-style Date Picker Popover -->
                        <div class="date-picker-popover" id="calendarExpansion">
                            <div class="date-picker-content">
                                <!-- Date inputs row -->
                                <div class="date-picker-inputs">
                                    <div class="input-group">
                                        <input type="date" id="expandedStartDate" onchange="updateTempDates()" class="date-input">
                                    </div>
                                    <span class="date-separator">to</span>
                                    <div class="input-group">
                                        <input type="date" id="expandedEndDate" onchange="updateTempDates()" class="date-input">
                                    </div>
                                </div>
                                
                                <!-- Quick presets -->
                                <div class="date-presets">
                                    <button class="preset-btn" onclick="setQuickRange(7)">Last 7 days</button>
                                    <button class="preset-btn" onclick="setQuickRange(30)">Last 30 days</button>
                                    <button class="preset-btn" onclick="setQuickRange('month')">This month</button>
                                    <button class="preset-btn" onclick="setQuickRange('all')">All time</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-item">
                        <select id="speciesSelect" class="filter-select">
                            <option value="all">All Species</option>
                        </select>
                    </div>

                    <div class="filter-item">
                        <select id="durationSelect" class="filter-select">
                            <option value="all">All Durations</option>
                        </select>
                    </div>
                </div>

                <div class="filter-right">
                    <div class="filter-item" style="flex:1 1 0; min-width:0;">
                        <select id="boatSelect" class="filter-select">
                            <option value="all">All Boats</option>
                        </select>
                    </div>
                </div>

                <button id="resetFilters" class="reset-filters">
                    Reset
                </button>
            </div>
        </div>
        
        <div class="container">

        <div id="loading" class="loading">
            <p>Loading fishing data and calculating moon phases...</p>
        </div>

        <div id="error" class="error" style="display:none;">
        </div>

        <div id="content" style="display:none;">
            <!-- Premium Statistics Dashboard -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="totalTrips">-</div>
                    <div class="stat-label">Trips</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalFish">-</div>
                    <div class="stat-label">Fish</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgFishPerTrip">-</div>
                    <div class="stat-label">Avg per Trip</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalBoats">-</div>
                    <div class="stat-label">Boats</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title" id="moonPhaseChartTitle">Fish Catches by Moon Phase</div>
                </div>
                <canvas id="moonPhaseChart" class="chart-canvas"></canvas>
            </div>


            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title" id="boatChartTitle">Top Performing Boats</div>
                </div>
                <div class="chart-scroll">
                  <canvas id="boatChart" class="chart-canvas"></canvas>
                </div>
            </div>

            <div class="chart-container" id="timeChartContainer">
                <div class="chart-header">
                    <div class="chart-title" id="timeChartTitle">Daily Fish Catches Over Time</div>
                </div>
                <canvas id="timeChart" class="chart-canvas"></canvas>
                <div id="moonPhaseInfo" style="margin-top: 10px; padding: 10px; background-color: #f5f5f5; border-radius: 5px; display: none;">
                    <strong>Selected Date Info:</strong>
                    <div id="moonPhaseDetails"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = "https://ulsbtwqhwnrpkourphiq.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVsc2J0d3Fod25ycGtvdXJwaGlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1ODkyMjksImV4cCI6MjA3MjE2NTIyOX0.neoabBKdVpngZpRkYTxp7Z5WhTXX4uwCnb78N81s_Vk";

        // Global variables
        let allTrips = [];
        let allBoats = [];
        let allCatches = [];
        let allSpecies = [];
        let charts = {};
        let dataRange = { minDate: null, maxDate: null, totalTrips: 0, totalFish: 0 };

        // Parse trip duration to actual days on water
        function parseDurationToDays(duration) {
            if (!duration) return 1.0;
            
            const durationLower = duration.toLowerCase().trim();
            
            // First handle fractions (must come before whole numbers)
            if (durationLower.includes('1/2 day')) return 0.5;
            if (durationLower.includes('3/4 day')) return 0.75;
            
            // Handle decimal days (1.5 Day, 2.5 Day, etc.)
            const decimalMatch = durationLower.match(/(\d+\.\d+)\s*day/);
            if (decimalMatch) return parseFloat(decimalMatch[1]);
            
            // Handle whole number days (2 Day, 3 Day, etc.) - but not if part of fraction
            if (!durationLower.includes('/')) {
                const wholeMatch = durationLower.match(/^(\d+)\s*day/);
                if (wholeMatch) return parseFloat(wholeMatch[1]);
            }
            
            // Handle special cases (aligned with canonical rules)
            if (durationLower.includes('full day')) return 1.0;
            if (durationLower.includes('overnight')) return 1.0; // Overnight treated as 1.0 day for analytics
            if (durationLower.includes('twilight')) return 0.25;
            
            // Default fallback
            console.warn(`Could not parse duration: "${duration}" - defaulting to 1 day`);
            return 1.0;
        }

        // Initialize the application
    async function init() {
            try {
                await loadData();
                initializeCurrentDateState();
                setupCalendarEventListeners();
                calculateMoonPhases();
                updateNextMoonPhaseBanner();
                createCharts();
                updateStats();
                updateDateRangeDisplay();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
                // Set up auto-refresh every 5 minutes to detect new data
                setInterval(async () => {
                    try {
                        const currentTripCount = allTrips.length;
                        await loadData();
                        
                        // If new data detected, refresh charts
                        if (allTrips.length > currentTripCount) {
                            console.log('New data detected, refreshing charts...');
                            calculateMoonPhases();
                            createCharts();
                            updateStats();
                        }
                    } catch (error) {
                        console.error('Auto-refresh error:', error);
                    }
                }, 300000); // 5 minutes
                
            } catch (error) {
                console.error('Error initializing:', error);
                showError('Failed to load data: ' + error.message);
            }
        }

        // Show "X days till <icon>" for the next lunar phase in the navbar
        function updateNextMoonPhaseBanner() {
            try {
                const SYNODIC_MONTH = 29.530589;
                const KNOWN_NEW_MOON = new Date('2025-07-24');
                const now = new Date();
                const daysSince = (now - KNOWN_NEW_MOON) / (1000 * 60 * 60 * 24);
                const pos = ((daysSince % SYNODIC_MONTH) + SYNODIC_MONTH) % SYNODIC_MONTH;
                const phases = [
                    { pos: 0, name: 'New Moon', icon: '🌑' },
                    { pos: 2, name: 'Waxing Crescent', icon: '🌒' },
                    { pos: 7, name: 'First Quarter', icon: '🌓' },
                    { pos: 9, name: 'Waxing Gibbous', icon: '🌔' },
                    { pos: 14, name: 'Full Moon', icon: '🌕' },
                    { pos: 16, name: 'Waning Gibbous', icon: '🌖' },
                    { pos: 21, name: 'Third Quarter', icon: '🌗' },
                    { pos: 23, name: 'Waning Crescent', icon: '🌘' },
                    { pos: SYNODIC_MONTH, name: 'New Moon', icon: '🌑' }
                ];
                // Find next boundary after current position
                let next = phases.find(p => p.pos > pos);
                if (!next) next = phases[0];
                let delta = next.pos - pos;
                if (delta < 0) delta += SYNODIC_MONTH;
                const days = Math.ceil(delta);
                const el = document.getElementById('nextMoonPhaseBanner');
                if (el) {
                    // Show only the upcoming moon phase icon (no day countdown)
                    el.innerHTML = `<span class="moon-phase-icon" title="${next.name}">${next.icon}</span>`;
                }
            } catch (_) {
                // ignore
            }
        }

        // Update header stats dynamically (removed - no longer needed)
        function updateHeaderStats() {
            // Header stats removed from navigation for cleaner design
        }

        // Load data from Supabase (now with increased max rows limit)
        async function loadData() {
            const headers = {
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
                'Content-Type': 'application/json'
            };

            // Load ALL trips (should now get all records with increased limit)
            const tripsResponse = await fetch(`${SUPABASE_URL}/rest/v1/trips?select=*,boats(name,landings(name)),catches(species,count)&order=trip_date`, {
                headers: headers
            });
            
            if (!tripsResponse.ok) {
                throw new Error(`HTTP error! status: ${tripsResponse.status}`);
            }
            
            allTrips = await tripsResponse.json();
            console.log('Loaded ALL trips data:', allTrips.length, 'records');
            
            // Debug: Check if Liberty's July 29th trip is loaded
            const libertyJuly29Trip = allTrips.find(t => t.id === 1381);
            console.log('Liberty July 29th trip in frontend:', libertyJuly29Trip);

            // Load ALL catches (should now get all records with increased limit)
            const catchesResponse = await fetch(`${SUPABASE_URL}/rest/v1/catches?select=*`, {
                headers: headers
            });
            
            if (!catchesResponse.ok) {
                throw new Error(`HTTP error! status: ${catchesResponse.status}`);
            }
            
            allCatches = await catchesResponse.json();
            console.log('Loaded ALL catches data:', allCatches.length, 'records');
            
            // Debug: Check if Liberty's July 29th catch data is loaded
            const libertyJuly29Catches = allCatches.filter(c => c.trip_id === 1381);
            console.log('Liberty July 29th catches in frontend:', libertyJuly29Catches);

            // Load boats for selector (remove default limit)
            const boatsResponse = await fetch(`${SUPABASE_URL}/rest/v1/boats?select=*,landings(name)&order=name&limit=1000`, {
                headers: headers
            });
            
            if (!boatsResponse.ok) {
                throw new Error(`HTTP error! status: ${boatsResponse.status}`);
            }
            
            allBoats = await boatsResponse.json();
            console.log('Loaded boats data:', allBoats.length, 'records');
            
            // Debug: Check if Liberty boat is loaded
            const libertyBoat = allBoats.find(b => b.name === 'Liberty');
            console.log('Liberty boat in frontend:', libertyBoat);
            
            // Calculate data range and totals for header
            if (allTrips.length > 0) {
                const dates = allTrips.map(t => t.trip_date).sort();
                dataRange.minDate = dates[0];
                dataRange.maxDate = dates[dates.length - 1];
                dataRange.totalTrips = allTrips.length;
                dataRange.totalFish = allTrips.reduce((sum, trip) => sum + (trip.total_fish || 0), 0);
                updateHeaderStats();
            }
            
            // Test duration parsing
            console.log('Duration parsing tests:');
            console.log('1/2 Day AM =', parseDurationToDays('1/2 Day AM'), 'days');
            console.log('2.5 Day =', parseDurationToDays('2.5 Day'), 'days');
            console.log('Full Day =', parseDurationToDays('Full Day'), 'days');
            console.log('Overnight =', parseDurationToDays('Overnight'), 'days');

            // Get unique species and populate species selector
            allSpecies = [...new Set(allCatches.map(c => c.species))].sort();
            const speciesSelect = document.getElementById('speciesSelect');
            allSpecies.forEach(species => {
                const option = document.createElement('option');
                option.value = species;
                option.textContent = species;
                speciesSelect.appendChild(option);
            });

            // Get unique trip durations and populate duration selector
            const allDurations = [...new Set(allTrips.map(t => t.trip_duration).filter(d => d))].sort((a, b) => {
                // Custom sort order for trip durations
                const order = [
                    '1/2 Day AM', '1/2 Day PM', '1/2 Day Twilight',
                    '3/4 Day',
                    'Full Day', 'Full Day (Local)', 'Full Day Offshore', 'Full Day Coronado Islands',
                    'Overnight',
                    '1.5 Day', '2 Day', '2.5 Day', '3 Day', '3.5 Day', '4 Day', '4.5 Day', '5 Day', '5.5 Day'
                ];
                const aIndex = order.indexOf(a);
                const bIndex = order.indexOf(b);
                if (aIndex === -1 && bIndex === -1) return a.localeCompare(b);
                if (aIndex === -1) return 1;
                if (bIndex === -1) return -1;
                return aIndex - bIndex;
            });
            const durationSelect = document.getElementById('durationSelect');
            allDurations.forEach(duration => {
                const option = document.createElement('option');
                option.value = duration;
                option.textContent = duration;
                durationSelect.appendChild(option);
            });

            // Initialize date range inputs
            initializeDateInputs();
            
            // Populate boat selector
            const boatSelect = document.getElementById('boatSelect');
            allBoats.forEach(boat => {
                const option = document.createElement('option');
                option.value = boat.id;
                const landingName = boat.landings ? boat.landings.name : 'Unknown Landing';
                option.textContent = `${boat.name} (${landingName})`;
                boatSelect.appendChild(option);
            });

            // Event listeners are now set up in initializeDateInputs()
            speciesSelect.addEventListener('change', updateCharts);
            boatSelect.addEventListener('change', updateAllCharts);
            durationSelect.addEventListener('change', updateAllCharts);
        }

        // Calculate moon phases for each trip
        function calculateMoonPhases() {
            const SYNODIC_MONTH = 29.530589; // Average length of lunar cycle in days
            const KNOWN_NEW_MOON = new Date('2025-07-24'); // Known new moon date

            allTrips.forEach(trip => {
                const tripDate = new Date(trip.trip_date);
                const daysSinceNewMoon = (tripDate - KNOWN_NEW_MOON) / (1000 * 60 * 60 * 24);
                const cyclePosition = ((daysSinceNewMoon % SYNODIC_MONTH) + SYNODIC_MONTH) % SYNODIC_MONTH;
                
                // Determine moon phase
                if (cyclePosition < 2) trip.moonPhase = 'New Moon';
                else if (cyclePosition < 7) trip.moonPhase = 'Waxing Crescent';
                else if (cyclePosition < 9) trip.moonPhase = 'First Quarter';
                else if (cyclePosition < 14) trip.moonPhase = 'Waxing Gibbous';
                else if (cyclePosition < 16) trip.moonPhase = 'Full Moon';
                else if (cyclePosition < 21) trip.moonPhase = 'Waning Gibbous';
                else if (cyclePosition < 23) trip.moonPhase = 'Third Quarter';
                else trip.moonPhase = 'Waning Crescent';

                // Add moon phase icon
                const icons = {
                    'New Moon': '🌑',
                    'Waxing Crescent': '🌒',
                    'First Quarter': '🌓',
                    'Waxing Gibbous': '🌔',
                    'Full Moon': '🌕',
                    'Waning Gibbous': '🌖',
                    'Third Quarter': '🌗',
                    'Waning Crescent': '🌘'
                };
                trip.moonIcon = icons[trip.moonPhase];
            });
        }

        // Initialize date range inputs with available data (updated for new calendar system)
        function initializeDateInputs() {
            if (allTrips.length === 0) return;
            
            // Get min and max dates from data
            const dates = allTrips.map(t => t.trip_date).sort();
            const minDate = dates[0];
            const maxDate = dates[dates.length - 1];
            
            // Set min/max values for the expandable date inputs (if they exist)
            const expandedStartInput = document.getElementById('expandedStartDate');
            const expandedEndInput = document.getElementById('expandedEndDate');
            
            if (expandedStartInput && expandedEndInput) {
                expandedStartInput.min = minDate;
                expandedStartInput.max = maxDate;
                
                expandedEndInput.min = minDate;
                expandedEndInput.max = maxDate;
            }
            
            // This is now handled by initializeCurrentDateState() and updateDateRangeDisplay()
            // Event listeners for the new calendar system are set up in setupCalendarEventListeners()
        }
        
        // Handle date range changes
        function handleDateRangeChange() {
            updateAllCharts();
        }
        
        // Reset date range to show all data
        function resetDateRange() {
            const dates = allTrips.map(t => t.trip_date).sort();
            const minDate = dates[0];
            const maxDate = dates[dates.length - 1];
            
            document.getElementById('startDate').value = minDate;
            document.getElementById('endDate').value = maxDate;
            updateAllCharts();
        }

        // Get filtered data based on selected species, boat, and date range
        function getFilteredData() {
            const selectedSpecies = document.getElementById('speciesSelect').value;
            const selectedBoat = document.getElementById('boatSelect').value;
            const selectedDuration = document.getElementById('durationSelect').value;

            let filteredTrips = allTrips;
            let filteredCatches = allCatches;

            // Filter by date range using current state variables
            if (currentStartDate && currentEndDate) {
                filteredTrips = filteredTrips.filter(trip => {
                    return trip.trip_date >= currentStartDate && trip.trip_date <= currentEndDate;
                });
                const selectedDateTripIds = filteredTrips.map(trip => trip.id);
                filteredCatches = filteredCatches.filter(c => selectedDateTripIds.includes(c.trip_id));
            }

            // Filter by duration if selected
            if (selectedDuration !== 'all') {
                filteredTrips = filteredTrips.filter(trip => trip.trip_duration === selectedDuration);
                const selectedDurationTripIds = filteredTrips.map(trip => trip.id);
                filteredCatches = filteredCatches.filter(c => selectedDurationTripIds.includes(c.trip_id));
            }

            // Filter by boat if selected
            if (selectedBoat !== 'all') {
                filteredTrips = filteredTrips.filter(trip => trip.boat_id == selectedBoat);
                const selectedBoatTripIds = filteredTrips.map(trip => trip.id);
                filteredCatches = filteredCatches.filter(c => selectedBoatTripIds.includes(c.trip_id));
            }
            
            // Then filter by species if selected
            if (selectedSpecies !== 'all') {
                filteredCatches = filteredCatches.filter(c => c.species === selectedSpecies);
                const tripIdsWithSpecies = [...new Set(filteredCatches.map(c => c.trip_id))];
                filteredTrips = filteredTrips.filter(trip => tripIdsWithSpecies.includes(trip.id));
            }
            
            return {
                trips: filteredTrips,
                catches: filteredCatches
            };
        }

        // Create all charts
        function createCharts() {
            createMoonPhaseChart();
            createBoatChart();
            createTimeChart();
        }

        // Removed mobile fullscreen expansion for time chart

        // Update charts when species changes
        function updateCharts() {
            createMoonPhaseChart();
            createBoatChart();
            createTimeChart();
            updateStats();
            updateHeaderForSelection();
        }

        // Update all charts when boat or date selection changes
        function updateAllCharts() {
            createMoonPhaseChart();
            createBoatChart();  
            createTimeChart();
            updateStats();
            updateHeaderForSelection();
        }
        
        // Update header when filters are applied
        function updateHeaderForSelection() {
            const filteredData = getFilteredData();
            
            if (filteredData.trips.length > 0 && currentStartDate && currentEndDate) {
                const totalFish = filteredData.trips.reduce((sum, trip) => sum + (trip.total_fish || 0), 0);
                
                // Create date range display
                const start = new Date(currentStartDate);
                const end = new Date(currentEndDate);
                const startMonth = start.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                const endMonth = end.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                let dateRangeText;
                if (startMonth === endMonth) {
                    dateRangeText = startMonth;
                } else {
                    dateRangeText = `${startMonth} - ${endMonth}`;
                }
                
                // Update was moved to updateHeaderStats() function
            } else {
                updateHeaderStats(); // Use the original full dataset stats
            }
        }

        // Create moon phase analysis chart
        function createMoonPhaseChart() {
            const filteredData = getFilteredData();
            const selectedSpecies = document.getElementById('speciesSelect').value;
            const selectedBoat = document.getElementById('boatSelect').value;
            
            // Update chart title
            let chartTitle = 'Fish Catches by Moon Phase';
            let titleParts = [];
            
            if (selectedSpecies !== 'all') titleParts.push(selectedSpecies);
            if (selectedBoat !== 'all') {
                const boat = allBoats.find(b => b.id == selectedBoat);
                titleParts.push(boat?.name || 'Selected Boat');
            }
            if (currentStartDate && currentEndDate && filteredData.trips.length > 0 && filteredData.trips.length < allTrips.length) {
                const start = new Date(currentStartDate);
                const end = new Date(currentEndDate);
                const startMonth = start.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                const endMonth = end.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                
                if (startMonth === endMonth) {
                    titleParts.push(startMonth);
                } else {
                    titleParts.push(`${startMonth} - ${endMonth}`);
                }
            }
            
            if (titleParts.length > 0) {
                chartTitle = `${selectedSpecies === 'all' ? 'Fish' : selectedSpecies} Catches by Moon Phase - ${titleParts.join(' | ')}`;
            }
            
            const titleElement = document.getElementById('moonPhaseChartTitle');
            if (titleElement) {
                titleElement.textContent = chartTitle;
            }
            
            const phases = ['New Moon', 'Waxing Crescent', 'First Quarter', 'Waxing Gibbous', 
                          'Full Moon', 'Waning Gibbous', 'Third Quarter', 'Waning Crescent'];
            const icons = ['🌑', '🌒', '🌓', '🌔', '🌕', '🌖', '🌗', '🌘'];

            const phaseData = phases.map(phase => {
                const phaseTrips = filteredData.trips.filter(trip => trip.moonPhase === phase);
                
                let totalFish, avgFishPerTrip;
                if (selectedSpecies === 'all') {
                    totalFish = phaseTrips.reduce((sum, trip) => sum + (trip.total_fish || 0), 0);
                    avgFishPerTrip = phaseTrips.length > 0 ? totalFish / phaseTrips.length : 0;
                } else {
                    // Count only the selected species
                    totalFish = filteredData.catches
                        .filter(c => phaseTrips.some(trip => trip.id === c.trip_id))
                        .reduce((sum, c) => sum + c.count, 0);
                    avgFishPerTrip = phaseTrips.length > 0 ? totalFish / phaseTrips.length : 0;
                }
                
                return {
                    phase: phase,
                    trips: phaseTrips.length,
                    totalFish: totalFish,
                    avgFishPerTrip: avgFishPerTrip.toFixed(1)
                };
            });

            if (charts.moonPhase) {
                charts.moonPhase.destroy();
            }

            const ctx = document.getElementById('moonPhaseChart').getContext('2d');
            charts.moonPhase = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: phases.map((phase, i) => `${icons[i]} ${phase}`),
                    datasets: [{
                        label: selectedSpecies === 'all' ? 'Average Fish per Trip' : `Average ${selectedSpecies} per Trip`,
                        data: phaseData.map(d => d.avgFishPerTrip),
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const data = phaseData[context.dataIndex];
                                    return [`Trips: ${data.trips}`, `Total Fish: ${data.totalFish}`];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Average Fish per Trip'
                            }
                        }
                    }
                }
            });
        }

        // Create boat analysis chart showing top boats by total fish caught
        function createBoatChart(selectedBoatId = 'all') {
            const filteredData = getFilteredData();
            const selectedSpecies = document.getElementById('speciesSelect').value;
            let boatData;
            
            if (selectedBoatId === 'all') {
                // Show top boats by total fish caught (simplified)
                boatData = allBoats.map(boat => {
                    const boatTrips = filteredData.trips.filter(trip => trip.boat_id === boat.id);
                    
                    if (boatTrips.length === 0) return null;
                    
                    let totalFish;
                    if (selectedSpecies === 'all') {
                        totalFish = boatTrips.reduce((sum, trip) => sum + (trip.total_fish || 0), 0);
                    } else {
                        totalFish = filteredData.catches
                            .filter(c => boatTrips.some(trip => trip.id === c.trip_id))
                            .reduce((sum, c) => sum + c.count, 0);
                    }
                    
                    // For the Top Boats tile, show only the boat name (omit landing to prevent truncation)
                    return {
                        name: `${boat.name}`,
                        trips: boatTrips.length,
                        totalFish: totalFish
                    };
                }).filter(d => d !== null)
                  .sort((a, b) => b.totalFish - a.totalFish)
                  .slice(0, 15); // Top 15 boats

                // Update chart title
                const speciesText = selectedSpecies === 'all' ? 'Fish' : selectedSpecies;
                const boatTitleElement = document.getElementById('boatChartTitle');
                if (boatTitleElement) {
                    boatTitleElement.textContent = `Top Boats by Total ${speciesText} Caught`;
                }
            } else {
                // Individual boat by moon phase
                const boat = allBoats.find(b => b.id == selectedBoatId);
                const boatTrips = filteredData.trips.filter(trip => trip.boat_id == selectedBoatId);
                
                const phases = ['New Moon', 'Waxing Crescent', 'First Quarter', 'Waxing Gibbous', 
                              'Full Moon', 'Waning Gibbous', 'Third Quarter', 'Waning Crescent'];
                
                boatData = phases.map(phase => {
                    const phaseTrips = boatTrips.filter(trip => trip.moonPhase === phase);
                    
                    let totalFish;
                    if (selectedSpecies === 'all') {
                        totalFish = phaseTrips.reduce((sum, trip) => sum + (trip.total_fish || 0), 0);
                    } else {
                        totalFish = filteredData.catches
                            .filter(c => phaseTrips.some(trip => trip.id === c.trip_id))
                            .reduce((sum, c) => sum + c.count, 0);
                    }
                    
                    const avgFishPerTrip = phaseTrips.length > 0 ? totalFish / phaseTrips.length : 0;
                    
                    return {
                        name: phase,
                        trips: phaseTrips.length,
                        totalFish: totalFish,
                        avgFishPerTrip: avgFishPerTrip.toFixed(1)
                    };
                });

                const speciesText = selectedSpecies === 'all' ? 'Fish' : selectedSpecies;
                const boatTitleElement = document.getElementById('boatChartTitle');
                if (boatTitleElement) {
                    boatTitleElement.textContent = `${boat.name} - Avg ${speciesText} per Trip by Moon Phase`;
                }
            }

            if (charts.boat) {
                charts.boat.destroy();
            }

            const boatCanvasEl = document.getElementById('boatChart');
            // Dynamically set canvas height based on number of bars so the wrapper can scroll
            try {
              const barHeight = 28; // px per bar
              const padding = 80;   // space for axes/labels
              const desired = (boatData?.length || 0) * barHeight + padding;
              // Cap the canvas height so the scroll container handles overflow
              boatCanvasEl.height = Math.min(Math.max(desired, 200), 1200);
            } catch (_) { /* no-op */ }

            const ctx = boatCanvasEl.getContext('2d');
            charts.boat = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: boatData.map(d => d.name),
                    datasets: [{
                        label: selectedBoatId === 'all' ? 'Total Fish Caught' : 'Avg Fish per Trip',
                        data: boatData.map(d => selectedBoatId === 'all' ? d.totalFish : d.avgFishPerTrip),
                        backgroundColor: 'rgba(255, 99, 132, 0.8)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const data = boatData[context.dataIndex];
                                    if (selectedBoatId === 'all') {
                                        return [
                                            `Total Trips: ${data.trips}`,
                                            `Total Fish Caught: ${data.totalFish.toLocaleString()}`
                                        ];
                                    } else {
                                        return [`Trips: ${data.trips}`, `Total Fish: ${data.totalFish}`];
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: selectedBoatId === 'all' ? 'Total Fish Caught' : 'Average Fish per Trip'
                            }
                        }
                    }
                }
            });
        }

        // Create time series chart
        function createTimeChart() {
            const filteredData = getFilteredData();
            const selectedSpecies = document.getElementById('speciesSelect').value;
            const selectedBoat = document.getElementById('boatSelect').value;
            
            // Group trips by date and calculate daily totals
            const dailyTotals = {};
            filteredData.trips.forEach(trip => {
                const date = trip.trip_date;
                if (!dailyTotals[date]) {
                    dailyTotals[date] = { fish: 0, trips: 0, moonPhase: trip.moonPhase };
                }
                
                if (selectedSpecies === 'all') {
                    dailyTotals[date].fish += trip.total_fish || 0;
                } else {
                    // Add fish count for selected species only
                    const speciesFish = filteredData.catches
                        .filter(c => c.trip_id === trip.id)
                        .reduce((sum, c) => sum + c.count, 0);
                    dailyTotals[date].fish += speciesFish;
                }
                
                dailyTotals[date].trips += 1;
            });

            const sortedDates = Object.keys(dailyTotals).sort();
            const chartData = sortedDates.map(date => ({
                x: date,
                y: dailyTotals[date].fish,
                moonPhase: dailyTotals[date].moonPhase
            }));

            if (charts.time) {
                charts.time.destroy();
            }

            // Update chart title
            let chartTitle = 'Daily Fish Catches Over Time';
            if (selectedBoat !== 'all' && selectedSpecies !== 'all') {
                const boat = allBoats.find(b => b.id == selectedBoat);
                chartTitle = `Daily ${selectedSpecies} Catches - ${boat?.name || 'Selected Boat'}`;
            } else if (selectedBoat !== 'all') {
                const boat = allBoats.find(b => b.id == selectedBoat);
                chartTitle = `Daily Fish Catches - ${boat?.name || 'Selected Boat'}`;
            } else if (selectedSpecies !== 'all') {
                chartTitle = `Daily ${selectedSpecies} Catches - All Boats`;
            }
            const timeTitleElement = document.getElementById('timeChartTitle');
            if (timeTitleElement) {
                timeTitleElement.textContent = chartTitle;
            }

            const timeCanvas = document.getElementById('timeChart');
            try { timeCanvas.height = 320; } catch(_) {}
            const ctx = timeCanvas.getContext('2d');
            charts.time = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: selectedSpecies === 'all' ? 'Daily Fish Catch' : `Daily ${selectedSpecies} Catch`,
                        data: chartData,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const dataIndex = elements[0].index;
                            const date = sortedDates[dataIndex];
                            const dayData = dailyTotals[date];
                            
                            // Show moon phase info
                            displayMoonPhaseInfo(date, dayData);
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const data = context.parsed;
                                    const date = sortedDates[context.dataIndex];
                                    return [`Moon Phase: ${dailyTotals[date].moonPhase}`, 
                                           `Trips: ${dailyTotals[date].trips}`,
                                           `Click to see details`];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                tooltipFormat: 'MMM dd, yyyy',
                                displayFormats: {
                                    day: 'MMM dd'
                                }
                            },
                            // Clamp to selected date range so it doesn't extend past today
                            min: currentStartDate ? new Date(currentStartDate + 'T00:00:00') : undefined,
                            max: currentEndDate ? new Date(currentEndDate + 'T23:59:59') : undefined,
                            bounds: 'ticks',
                            ticks: { source: 'data' },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Total Fish Caught'
                            }
                        }
                    }
                }
            });
        }

        // Display detailed moon phase info when clicking on time chart
        function displayMoonPhaseInfo(date, dayData) {
            const selectedSpecies = document.getElementById('speciesSelect').value;
            
            // Get moon phase icon
            const icons = {
                'New Moon': '🌑',
                'Waxing Crescent': '🌒',
                'First Quarter': '🌓',
                'Waxing Gibbous': '🌔',
                'Full Moon': '🌕',
                'Waning Gibbous': '🌖',
                'Third Quarter': '🌗',
                'Waning Crescent': '🌘'
            };
            
            const moonIcon = icons[dayData.moonPhase] || '🌙';
            const speciesText = selectedSpecies === 'all' ? 'Fish' : selectedSpecies;
            
            // Get trips for this date to show boat details
            const dateTrips = (selectedSpecies === 'all' ? allTrips : getFilteredData().trips)
                .filter(trip => trip.trip_date === date);
            
            // Group by boat
            const boatSummary = {};
            dateTrips.forEach(trip => {
                const boat = allBoats.find(b => b.id === trip.boat_id);
                const boatName = boat ? boat.name : `Boat ${trip.boat_id}`;
                
                if (!boatSummary[boatName]) {
                    boatSummary[boatName] = {
                        trips: 0,
                        fish: 0,
                        tripTypes: new Set()
                    };
                }
                
                boatSummary[boatName].trips += 1;
                boatSummary[boatName].tripTypes.add(trip.trip_duration);
                
                if (selectedSpecies === 'all') {
                    boatSummary[boatName].fish += trip.total_fish || 0;
                } else {
                    // Count selected species for this trip
                    const speciesCatches = allCatches.filter(c => 
                        c.trip_id === trip.id && c.species === selectedSpecies
                    );
                    boatSummary[boatName].fish += speciesCatches.reduce((sum, c) => sum + c.count, 0);
                }
            });
            
            // Create display HTML
            const formattedDate = new Date(date).toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            let boatDetailsHtml = '';
            Object.entries(boatSummary)
                .sort((a, b) => b[1].fish - a[1].fish)
                .forEach(([boatName, data], index) => {
                    const tripTypesList = Array.from(data.tripTypes).join(', ');
                    const boatId = `boat-${date}-${index}`;
                    boatDetailsHtml += `
                        <div class="boat-detail" id="${boatId}" style="margin: 5px 0; padding: 8px; background: white; border-radius: 3px; border-left: 3px solid #2a5298;" 
                             onclick="toggleBoatDetails('${boatId}', '${boatName}', '${date}')">
                            <span><strong>${boatName}:</strong> ${data.fish} ${speciesText.toLowerCase()} 
                            (${data.trips} trip${data.trips !== 1 ? 's' : ''}: ${tripTypesList})</span>
                            <span class="boat-arrow">▼</span>
                        </div>
                        <div id="${boatId}-details" style="display: none;"></div>
                    `;
                });
            
            const infoHtml = `
                <div style="margin-bottom: 10px;">
                    <strong>${formattedDate}</strong><br>
                    <span style="font-size: 1.2em;">${moonIcon} ${dayData.moonPhase}</span><br>
                    <strong>Total:</strong> ${dayData.fish} ${speciesText.toLowerCase()} from ${dayData.trips} trip${dayData.trips !== 1 ? 's' : ''}
                </div>
                <div>
                    <strong>Boats on this day:</strong> <span class="clickable-hint">(click boat names for species breakdown)</span>
                    ${boatDetailsHtml}
                </div>
            `;
            
            document.getElementById('moonPhaseDetails').innerHTML = infoHtml;
            document.getElementById('moonPhaseInfo').style.display = 'block';
        }

        // Toggle boat details to show species breakdown
        function toggleBoatDetails(boatId, boatName, date) {
            const detailsDiv = document.getElementById(`${boatId}-details`);
            const boatDiv = document.getElementById(boatId);
            const arrow = boatDiv.querySelector('.boat-arrow');
            
            if (detailsDiv.style.display === 'none') {
                // Show details
                const selectedSpecies = document.getElementById('speciesSelect').value;
                const selectedBoat = document.getElementById('boatSelect').value;
                
                // Get boat ID from name (extract just boat name, not the landing part)
                const justBoatName = boatName.includes('(') ? boatName.split('(')[0].trim() : boatName.trim();
                const targetBoat = allBoats.find(b => b.name === justBoatName);
                
                console.log('Looking for boat:', justBoatName, 'Found boat ID:', targetBoat?.id);
                console.log('Date:', date, 'All boat names:', allBoats.map(b => b.name));
                
                // Get all trips for this boat on this date
                let relevantTrips = [];
                if (targetBoat) {
                    if (selectedBoat !== 'all') {
                        // If boat is filtered, use filtered data
                        relevantTrips = getFilteredData().trips.filter(trip => 
                            trip.trip_date === date && trip.boat_id === targetBoat.id
                        );
                    } else {
                        // If no boat filter, get all trips for this boat on this date
                        relevantTrips = allTrips.filter(trip => 
                            trip.trip_date === date && trip.boat_id === targetBoat.id
                        );
                    }
                }
                
                // Get species breakdown for each trip
                let detailsHtml = '<div class="species-breakdown">';
                
                console.log('Debugging boat details:', { boatName, date, relevantTrips: relevantTrips.length, allCatchesLength: allCatches.length });
                
                relevantTrips.forEach((trip, tripIndex) => {
                    console.log('Processing trip:', trip.id, trip.trip_duration, 'total_fish:', trip.total_fish);
                    
                    // Get catches for this trip
                    let tripCatches;
                    if (selectedSpecies === 'all') {
                        tripCatches = allCatches.filter(c => c.trip_id === trip.id);
                    } else {
                        tripCatches = allCatches.filter(c => c.trip_id === trip.id && c.species === selectedSpecies);
                    }
                    
                    console.log('Trip catches found:', tripCatches.length, 'Catches:', tripCatches);
                    
                    if (tripCatches.length > 0) {
                        detailsHtml += `<div style="margin-bottom: 8px;"><strong>${trip.trip_duration} Trip (${trip.anglers} anglers):</strong><br>`;
                        
                        // Group by species and sum counts
                        const speciesCounts = {};
                        tripCatches.forEach(catchRecord => {
                            if (speciesCounts[catchRecord.species]) {
                                speciesCounts[catchRecord.species] += catchRecord.count;
                            } else {
                                speciesCounts[catchRecord.species] = catchRecord.count;
                            }
                        });
                        
                        // Display species breakdown
                        Object.entries(speciesCounts)
                            .sort((a, b) => b[1] - a[1])
                            .forEach(([species, count]) => {
                                detailsHtml += `&nbsp;&nbsp;• ${count} ${species}<br>`;
                            });
                        
                        detailsHtml += '</div>';
                    } else {
                        // Show total_fish from trip record even if no detailed catches
                        const totalFromTrip = trip.total_fish || 0;
                        if (totalFromTrip > 0) {
                            detailsHtml += `<div style="margin-bottom: 8px;"><strong>${trip.trip_duration} Trip:</strong><br>&nbsp;&nbsp;<em>Total: ${totalFromTrip} fish (detailed breakdown not available)</em><br></div>`;
                        } else {
                            detailsHtml += `<div style="margin-bottom: 8px;"><strong>${trip.trip_duration} Trip:</strong><br>&nbsp;&nbsp;<em>No catches recorded</em><br></div>`;
                        }
                    }
                });
                
                if (detailsHtml === '<div class="species-breakdown">') {
                    detailsHtml += '<em>No trips found for this boat on this date</em>';
                }
                
                detailsHtml += '</div>';
                
                detailsDiv.innerHTML = detailsHtml;
                detailsDiv.style.display = 'block';
                boatDiv.classList.add('boat-expanded');
                arrow.innerHTML = '▲';
            } else {
                // Hide details
                detailsDiv.style.display = 'none';
                boatDiv.classList.remove('boat-expanded');
                arrow.innerHTML = '▼';
            }
        }

        // Update boat chart when selection changes
        function updateBoatChart() {
            const selectedBoat = document.getElementById('boatSelect').value;
            createBoatChart(selectedBoat);
        }

        // Update statistics
        function updateStats() {
            const filteredData = getFilteredData();
            const selectedSpecies = document.getElementById('speciesSelect').value;
            
            const totalTrips = filteredData.trips.length;
            let totalFish;
            
            if (selectedSpecies === 'all') {
                totalFish = filteredData.trips.reduce((sum, trip) => sum + (trip.total_fish || 0), 0);
            } else {
                totalFish = filteredData.catches.reduce((sum, c) => sum + c.count, 0);
            }
            
            const avgFishPerTrip = totalTrips > 0 ? (totalFish / totalTrips).toFixed(1) : 0;
            const totalBoats = [...new Set(filteredData.trips.map(trip => trip.boat_id))].length;

            document.getElementById('totalTrips').textContent = totalTrips.toLocaleString();
            document.getElementById('totalFish').textContent = totalFish.toLocaleString();
            document.getElementById('avgFishPerTrip').textContent = avgFishPerTrip;
            document.getElementById('totalBoats').textContent = totalBoats;
        }

        // Show error message
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').textContent = message;
        }

        // Update date range display
        function updateDateRangeDisplay() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const display = document.getElementById('dateRangeDisplay');
            
            if (startDate && endDate) {
                const start = new Date(startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const end = new Date(endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                display.textContent = `${start} - ${end}`;
            } else {
                display.textContent = 'Select dates';
            }
            
            // Trigger filter update
            handleDateRangeChange();
        }
        
        // Calendar expansion variables
        let calendarExpanded = false;
        
        // Toggle calendar expansion
        function toggleCalendarExpansion() {
            const expansion = document.getElementById('calendarExpansion');
            const display = document.getElementById('dateRangeDisplay');
            
            if (calendarExpanded) {
                // Close calendar
                expansion.classList.remove('expanded');
                display.classList.remove('expanded');
                calendarExpanded = false;
            } else {
                // Open calendar
                expansion.classList.add('expanded');
                display.classList.add('expanded');
                
                // Initialize with current values
                populateExpandedDates();
                calendarExpanded = true;
            }
        }
        
        // Populate expanded date inputs with current values
        function populateExpandedDates() {
            const currentStart = getCurrentStartDate();
            const currentEnd = getCurrentEndDate();
            
            document.getElementById('expandedStartDate').value = currentStart;
            document.getElementById('expandedEndDate').value = currentEnd;
        }
        
        // Get current start date from filtered data
        function getCurrentStartDate() {
            if (filteredTrips && filteredTrips.length > 0) {
                const dates = filteredTrips.map(t => t.trip_date).sort();
                return dates[0];
            } else if (allTrips && allTrips.length > 0) {
                const dates = allTrips.map(t => t.trip_date).sort();
                return dates[0];
            }
            return '';
        }
        
        // Get current end date from filtered data
        function getCurrentEndDate() {
            if (filteredTrips && filteredTrips.length > 0) {
                const dates = filteredTrips.map(t => t.trip_date).sort();
                return dates[dates.length - 1];
            } else if (allTrips && allTrips.length > 0) {
                const dates = allTrips.map(t => t.trip_date).sort();
                return dates[dates.length - 1];
            }
            return '';
        }
        
        // Update temporary dates (called when date inputs change)
        function updateTempDates() {
            // This function is called when the expanded date inputs change
            // For now, we just validate that start <= end
            const start = document.getElementById('expandedStartDate').value;
            const end = document.getElementById('expandedEndDate').value;
            
            if (start && end && start > end) {
                // Swap if start is after end
                document.getElementById('expandedStartDate').value = end;
                document.getElementById('expandedEndDate').value = start;
            }
        }
        
        // Set quick date range
        function setQuickRange(period) {
            const today = new Date();
            let startDate, endDate;
            
            switch(period) {
                case 7:
                    // Last 7 days
                    endDate = new Date(today);
                    startDate = new Date(today);
                    startDate.setDate(startDate.getDate() - 7);
                    break;
                    
                case 30:
                    // Last 30 days
                    endDate = new Date(today);
                    startDate = new Date(today);
                    startDate.setDate(startDate.getDate() - 30);
                    break;
                    
                case 'month':
                    // This month
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0); // Last day of current month
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1); // First day of current month
                    break;
                    
                case 'all':
                    // All available data
                    if (allTrips && allTrips.length > 0) {
                        const dates = allTrips.map(t => t.trip_date).sort();
                        startDate = new Date(dates[0]);
                        endDate = new Date(dates[dates.length - 1]);
                    } else {
                        return; // No data available
                    }
                    break;
                    
                default:
                    return;
            }
            
            // Format dates for input fields (YYYY-MM-DD)
            const formatDate = (date) => date.toISOString().split('T')[0];

            // Ensure we don't go beyond available data range
            if (allTrips && allTrips.length > 0) {
                const availableDates = allTrips.map(t => t.trip_date).sort();
                const earliestAvailable = availableDates[0];
                const latestAvailable = availableDates[availableDates.length - 1];
                
                const formattedStart = formatDate(startDate);
                const formattedEnd = formatDate(endDate);
                
                // Constrain to available data range
                const finalStart = formattedStart < earliestAvailable ? earliestAvailable : formattedStart;
                const finalEnd = formattedEnd > latestAvailable ? latestAvailable : formattedEnd;
                
                document.getElementById('expandedStartDate').value = finalStart;
                document.getElementById('expandedEndDate').value = finalEnd;

                // Apply immediately
                currentStartDate = finalStart;
                currentEndDate = finalEnd;
                updateDateRangeDisplay();
                applyAllFilters();

                // Close the popover if open
                const expansion = document.getElementById('calendarExpansion');
                const display = document.getElementById('dateRangeDisplay');
                if (typeof calendarExpanded !== 'undefined' && calendarExpanded && expansion && display) {
                    expansion.classList.remove('expanded');
                    display.classList.remove('expanded');
                    calendarExpanded = false;
                }
            }
        }
        
        // Update temp dates and apply immediately (shadcn pattern)
        function updateTempDates() {
            const startDate = document.getElementById('expandedStartDate').value;
            const endDate = document.getElementById('expandedEndDate').value;
            
            // Validate dates
            if (!startDate || !endDate) return;
            
            if (startDate > endDate) {
                // Swap if start is after end
                document.getElementById('expandedStartDate').value = endDate;
                document.getElementById('expandedEndDate').value = startDate;
                return;
            }
            
            // Apply immediately (no Apply button needed)
            currentStartDate = startDate;
            currentEndDate = endDate;
            updateDateRangeDisplay();
            applyAllFilters();
        }
        
        // Variables to track current filter state
        let currentStartDate = '';
        let currentEndDate = '';
        
        // Initialize current date state when data loads
        // Default to Year-To-Date: Jan 1 of current year through today,
        // clamped to available data range.
        function initializeCurrentDateState() {
            if (allTrips && allTrips.length > 0) {
                const dates = allTrips.map(t => t.trip_date).sort();
                const earliestAvailable = dates[0];
                const latestAvailable = dates[dates.length - 1];

                const today = new Date();
                const yearStart = new Date(today.getFullYear(), 0, 1);
                const fmt = (d) => {
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    return `${y}-${m}-${day}`;
                };
                const yearStartStr = fmt(yearStart);
                const todayStr = fmt(today);

                // Clamp to available data
                currentStartDate = yearStartStr < earliestAvailable ? earliestAvailable : yearStartStr;
                currentEndDate = todayStr > latestAvailable ? latestAvailable : todayStr;
            }
        }
        
        // Apply all filters with current state (delegate to unified updateAllCharts)
        function applyAllFilters() {
            updateAllCharts();
        }
        
        // Update date range display text
        function updateDateRangeDisplay() {
            const display = document.getElementById('dateRangeDisplay');
            if (currentStartDate && currentEndDate) {
                const startFormatted = formatDateForDisplay(currentStartDate);
                const endFormatted = formatDateForDisplay(currentEndDate);
                display.textContent = `${startFormatted} - ${endFormatted}`;
            } else {
                display.textContent = 'Select Date Range';
            }
        }
        
        // Format date for display (e.g., "May 1, 2025")
        function formatDateForDisplay(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
        }
        
        // Setup event listeners for date picker (shadcn pattern)
        function setupCalendarEventListeners() {
            // Click outside detection
            document.addEventListener('click', function(event) {
                const popover = document.getElementById('calendarExpansion');
                const trigger = document.getElementById('dateRangeDisplay');
                
                // If picker is open and click is outside both trigger and popover
                if (calendarExpanded && 
                    !popover.contains(event.target) && 
                    !trigger.contains(event.target)) {
                    toggleCalendarExpansion();
                }
            });
            
            // Keyboard support
            document.addEventListener('keydown', function(event) {
                if (calendarExpanded && event.key === 'Escape') {
                    toggleCalendarExpansion();
                }
            });
            
            // Prevent popover from closing when clicking inside it
            document.getElementById('calendarExpansion').addEventListener('click', function(event) {
                event.stopPropagation();
            });
        }
        
        // Enhanced getCurrentStartDate using current state
        function getCurrentStartDate() {
            if (currentStartDate) {
                return currentStartDate;
            } else if (filteredTrips && filteredTrips.length > 0) {
                const dates = filteredTrips.map(t => t.trip_date).sort();
                return dates[0];
            } else if (allTrips && allTrips.length > 0) {
                const dates = allTrips.map(t => t.trip_date).sort();
                return dates[0];
            }
            return '';
        }
        
        // Enhanced getCurrentEndDate using current state  
        function getCurrentEndDate() {
            if (currentEndDate) {
                return currentEndDate;
            } else if (filteredTrips && filteredTrips.length > 0) {
                const dates = filteredTrips.map(t => t.trip_date).sort();
                return dates[dates.length - 1];
            } else if (allTrips && allTrips.length > 0) {
                const dates = allTrips.map(t => t.trip_date).sort();
                return dates[dates.length - 1];
            }
            return '';
        }
        
        // Reset all filters
        function resetAllFilters() {
            // Reset date range to all available data
            if (allTrips.length > 0) {
                const dates = allTrips.map(t => t.trip_date).sort();
                currentStartDate = dates[0];
                currentEndDate = dates[dates.length - 1];
                updateDateRangeDisplay();
            }
            
            // Reset species
            document.getElementById('speciesSelect').value = 'all';

            // Reset boat
            document.getElementById('boatSelect').value = 'all';

            // Reset duration
            document.getElementById('durationSelect').value = 'all';
            
            // Apply all filters with reset values
            applyAllFilters();
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);
        
        // Add event listener for reset button
        document.addEventListener('DOMContentLoaded', () => {
            const resetButton = document.getElementById('resetFilters');
            if (resetButton) {
                resetButton.addEventListener('click', resetAllFilters);
            }
        });
    </script>
</body>
</html>
